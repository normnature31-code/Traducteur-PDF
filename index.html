<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Word Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen p-4 flex items-center justify-center">

    <div class="max-w-md w-full bg-slate-800 rounded-3xl shadow-2xl p-6 border border-slate-700">
        <div class="text-center mb-6">
            <div class="bg-blue-500 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <h1 class="text-xl font-bold">Traducteur vers Word</h1>
            <p class="text-slate-400 text-xs mt-1">Crée un fichier .docx modifiable</p>
        </div>

        <div class="space-y-4">
            <input type="file" id="fileInput" accept="application/pdf" class="w-full text-sm text-slate-400">
            
            <div id="progBox" class="hidden bg-slate-900 p-4 rounded-xl border border-slate-700">
                <p id="status" class="text-xs text-blue-400 font-mono mb-2">Analyse...</p>
                <div class="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                    <div id="bar" class="h-full bg-blue-500 w-0 transition-all duration-300"></div>
                </div>
            </div>

            <button id="go" class="w-full bg-blue-600 hover:bg-blue-500 font-bold py-4 rounded-2xl transition-all shadow-lg shadow-blue-900/20">
                Traduire et Convertir en Word
            </button>

            <button id="share" class="hidden w-full bg-emerald-600 font-bold py-4 rounded-2xl animate-bounce">
                Partager le fichier Word
            </button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        async function translateText(text) {
            if (!text.trim()) return "";
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=fr&dt=t&q=${encodeURIComponent(text)}`;
                const response = await fetch(url);
                const data = await response.json();
                return data[0].map(x => x[0]).join('');
            } catch (e) { return text; }
        }

        document.getElementById('go').onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("Sélectionnez un PDF");

            document.getElementById('progBox').classList.remove('hidden');
            const btn = document.getElementById('go');
            btn.disabled = true;
            btn.innerText = "Conversion...";

            try {
                const pdfData = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
                
                const sections = [];

                for (let i = 1; i <= pdf.numPages; i++) {
                    document.getElementById('status').innerText = `Traduction Page ${i}/${pdf.numPages}...`;
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    // On regroupe le texte par paragraphes (basé sur la position Y)
                    let paragraphs = [];
                    let currentLine = "";
                    let lastY = -1;

                    for (const item of textContent.items) {
                        const y = Math.round(item.transform[5]);
                        if (lastY !== -1 && Math.abs(y - lastY) > 10) {
                            const translated = await translateText(currentLine);
                            paragraphs.push(new docx.Paragraph({
                                children: [new docx.TextRun(translated)],
                                spacing: { after: 200 }
                            }));
                            currentLine = item.str;
                        } else {
                            currentLine += " " + item.str;
                        }
                        lastY = y;
                    }
                    // Ajouter le dernier paragraphe de la page
                    if(currentLine) {
                        const translated = await translateText(currentLine);
                        paragraphs.push(new docx.Paragraph({ children: [new docx.TextRun(translated)] }));
                    }

                    // Saut de page dans Word
                    paragraphs.push(new docx.Paragraph({ children: [new docx.PageBreak()] }));
                    sections.push(...paragraphs);

                    const prog = Math.round((i / pdf.numPages) * 100);
                    document.getElementById('bar').style.width = prog + '%';
                }

                // Génération du document Word
                const doc = new docx.Document({
                    sections: [{ properties: {}, children: sections }]
                });

                const blob = await docx.Packer.toBlob(doc);
                window.wordBlob = blob;
                
                document.getElementById('share').classList.remove('hidden');
                document.getElementById('status').innerText = "Fichier Word prêt !";
                btn.style.display = 'none';

            } catch (e) {
                console.error(e);
                alert("Erreur lors de la création du fichier Word.");
                btn.disabled = false;
            }
        };

        document.getElementById('share').onclick = async () => {
            const f = new File([window.wordBlob], "Livre_Traduit.docx", {
                type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            });
            if(navigator.share) await navigator.share({files:[f], title:'Mon Livre Word'});
        };
    </script>
</body>
</html>
